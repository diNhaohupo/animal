<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测一测你的动物塑</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@500;700&display=swap');

        :root {
            --bg-color: #f8f9fc;
            --primary-text: #2d3748;
            --secondary-text: #4a5568;
            --accent-color: #6b46c1;
            --accent-light: #805ad5;
            --card-bg: #ffffff;
            --card-bg-light: #f7fafc;
            --border-color: #e2e8f0;
            --hover-bg: #f6f6ff;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --shadow-glow: 0 0 15px rgba(107, 70, 193, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            min-height: 100vh;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(107, 70, 193, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 70%, rgba(107, 70, 193, 0.03) 0%, transparent 30%),
                url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill="%23e2e8f0" fill-opacity="0.5"%3E%3Ccircle cx="50" cy="50" r="1.5"/%3E%3Ccircle cx="10" cy="10" r="1"/%3E%3Ccircle cx="90" cy="90" r="1"/%3E%3Ccircle cx="10" cy="90" r="1"/%3E%3Ccircle cx="90" cy="10" r="1"/%3E%3Ccircle cx="30" cy="70" r="0.5"/%3E%3Ccircle cx="70" cy="30" r="0.5"/%3E%3Ccircle cx="20" cy="50" r="0.75"/%3E%3Ccircle cx="80" cy="50" r="0.75"/%3E%3C/g%3E%3C/svg%3E');
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            transition: background-color 1s ease;
        }

        #start-screen h1,
        #start-screen h2,
        #start-screen .start-description {
            text-align: center;
        }

        #start-screen p {
            text-align: center;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        #quiz-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--card-bg);
            border-radius: 24px;
            box-shadow: var(--shadow), var(--shadow-glow);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            transform: perspective(1000px) rotateX(0deg);
        }

        #quiz-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
            opacity: 0.8;
        }

        .screen {
            padding: 40px;
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
                filter: blur(0);
            }
        }

        @keyframes fadeOut {
            from { 
                opacity: 1; 
                transform: translateY(0);
            }
            to { 
                opacity: 0; 
                transform: translateY(-20px);
                filter: blur(5px);
            }
        }

        .fade-out {
            animation: fadeOut 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        h1, h2, h3 {
            color: var(--primary-text);
            margin-bottom: 16px;
            position: relative;
        }

        h1 { 
            font-family: 'Noto Serif SC', serif;
            font-size: 2.2em; 
            letter-spacing: 3px; 
            text-align: center;
            background: linear-gradient(90deg, var(--accent-color), var(--primary-text));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 20px;
            animation: textGlow 3s ease-in-out infinite alternate;
        }

        @keyframes textGlow {
            from { text-shadow: 0 0 10px rgba(107, 70, 193, 0.1); }
            to { text-shadow: 0 0 20px rgba(107, 70, 193, 0.2); }
        }

        h2 { 
            font-size: 1.6em; 
            color: var(--accent-color); 
            margin-top: 0;
            text-align: center;
            font-weight: 500;
        }

        h3.question-title { 
            text-align: left; 
            font-size: 1.3em; 
            margin-bottom: 30px; 
            line-height: 1.8;
            padding-left: 4px;
            border-left: 3px solid var(--accent-color);
        }

        p {
            color: var(--secondary-text);
            line-height: 1.8;
            margin-bottom: 30px;
            font-size: 1.05em;
        }

        .start-button, .restart-button, .browse-button, .back-button, #verify-btn {
            display: block;
            width: 220px;
            margin: 30px auto 0;
            padding: 16px 20px;
            background: linear-gradient(45deg, var(--accent-color), var(--accent-light));
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(107, 70, 193, 0.2);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .back-button {
            width: auto;
            padding: 10px 20px;
            margin: 0 0 20px 0;
            background: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .back-button:hover {
            background-color: rgba(107, 70, 193, 0.05);
        }

        .start-button::after, .restart-button::after, .browse-button::after, #verify-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transform: rotate(30deg);
            transition: all 0.6s ease;
            z-index: -1;
        }

        .start-button:hover, .restart-button:hover, .browse-button:hover, #verify-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(107, 70, 193, 0.3);
        }

        .start-button:hover::after, .restart-button:hover::after, .browse-button:hover::after, #verify-btn:hover::after {
            left: 120%;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .option-list {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            flex-grow: 1;
        }

        .option-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 16px;
            padding: 20px 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: flex-start;
            position: relative;
            overflow: hidden;
            will-change: transform, background-color;
        }

        .option-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background-color: rgba(107, 70, 193, 0.05);
            transition: width 0.4s ease;
            z-index: 0;
        }

        .option-item:hover {
            background-color: var(--hover-bg);
            border-color: var(--accent-color);
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .option-item:hover::before {
            width: 100%;
        }

        .option-item.selected {
            background-color: rgba(107, 70, 193, 0.08);
            border-color: var(--accent-light);
            transform: translateX(3px);
        }

        .option-prefix {
            font-weight: 700;
            color: var(--accent-color);
            margin-right: 15px;
            font-size: 1.2em;
            min-width: 24px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .option-text {
            color: var(--primary-text);
            line-height: 1.7;
            position: relative;
            z-index: 1;
        }
        
        #progress-bar-container {
            width: 100%;
            background-color: rgba(226, 232, 240, 0.5);
            height: 8px;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            margin-bottom: 30px;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-light));
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        #progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(700px); }
        }
        
        #result-screen {
            text-align: center;
            padding: 50px 40px;
        }
        
        #result-screen h2 {
            font-family: 'Noto Serif SC', serif;
            font-size: 2em;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }
        
        #result-screen h3 {
            font-size: 2.2em;
            color: var(--accent-color);
            margin-bottom: 35px;
            text-align: center;
            font-weight: 700;
            text-shadow: 0 0 15px rgba(107, 70, 193, 0.2);
            animation: pulse 3s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #result-screen p {
            text-align: left;
            max-width: 90%;
            margin: 0 auto 40px;
            line-height: 1.9;
            font-size: 1.1em;
            padding: 25px;
            background-color: rgba(247, 250, 252, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.5s ease;
        }

        #result-screen p:hover {
            border-color: rgba(107, 70, 193, 0.3);
            box-shadow: 0 0 20px rgba(107, 70, 193, 0.08);
        }

        .hidden {
            display: none;
        }
        
        .screen-footer {
            text-align: center;
            font-size: 0.9em;
            color: var(--secondary-text);
            margin-top: 40px;
            opacity: 0.7;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid var(--accent-color);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #animal-guide {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 15px;
        }

        .animal-card {
            background-color: rgba(247, 250, 252, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .animal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(107, 70, 193, 0.1);
        }

        .animal-card h3 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .animal-card p {
            margin-bottom: 0;
            font-size: 1em;
        }

        @keyframes bgFloat {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            background-size: 200% 200%;
            animation: bgFloat 30s ease infinite;
        }

        .option-item.selected::after {
            content: '✓';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
            font-size: 1.5em;
            font-weight: bold;
            animation: checkmark 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes checkmark {
            0% { transform: translateY(-50%) scale(0); opacity: 0; }
            70% { transform: translateY(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateY(-50%) scale(1); opacity: 1; }
        }

        /* 验证屏幕样式 */
        #coupon-screen {
            text-align: center;
        }
        
        #coupon-input {
            width: 250px;
            padding: 12px;
            margin: 20px auto 20px;
            display: block;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
        }
        
        #coupon-error {
            color: #e53e3e;
            text-align: center;
            margin-top: 15px;
            min-height: 1.2em; /* 占位防止跳动 */
            display: block;
        }

        /* 结果可视化样式 */
        #result-stats {
            margin: 30px auto;
            max-width: 90%;
            padding: 20px;
            background-color: rgba(247, 250, 252, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .stats-title {
            font-size: 1.2em;
            color: var(--accent-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-chart {
            height: 200px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.5);
        }

        .stat-label {
            font-weight: 500;
        }

        .stat-bar-container {
            height: 10px;
            background-color: rgba(226, 232, 240, 0.5);
            border-radius: 5px;
            flex-grow: 1;
            margin: 0 15px;
            overflow: hidden;
        }

        .stat-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-light));
            border-radius: 5px;
            transition: width 1s ease-out;
        }

        .stat-value {
            min-width: 40px;
            text-align: right;
            font-weight: 500;
        }
        
        #cp-match-section {
            margin: 40px auto 0;
            max-width: 90%;
            padding: 25px 30px;
            background: linear-gradient(135deg, rgba(233, 213, 255, 0.2), rgba(250, 233, 255, 0.3));
            border-radius: 16px;
            border: 1px solid rgba(107, 70, 193, 0.2);
            box-shadow: 0 4px 20px rgba(107, 70, 193, 0.05);
            animation: fadeIn 1s ease 1s forwards;
            opacity: 0;
        }

        #cp-match-section .cp-title {
            color: var(--accent-color);
            font-size: 1.3em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        #cp-match-section .cp-title svg {
             width: 24px;
             height: 24px;
             fill: #c084fc;
             animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }

        #cp-match-section #cp-reason {
            margin-bottom: 20px;
            padding: 0;
            background-color: transparent;
            border: none;
            text-align: left;
            font-size: 1.05em;
            line-height: 1.9;
            color: var(--secondary-text);
        }

        #cp-match-section .cp-footer {
            text-align: center;
            font-size: 1.1em;
            color: var(--primary-text);
        }

        #cp-animal {
            font-weight: 700;
            font-family: 'Noto Serif SC', serif;
            color: var(--accent-light);
            font-size: 1.2em;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                min-height: 100vh;
                padding-bottom: 50px;
            }
            .screen {
                padding: 25px 20px;
                min-height: auto;
            }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }
            h3.question-title { 
                font-size: 1.15em; 
                padding-left: 3px;
            }
            .option-item { padding: 16px 20px; }
            #result-screen { padding: 30px 20px; }
            #result-screen h3 { font-size: 1.8em; }
            .button-group { flex-direction: column; align-items: center; }
            .stats-chart { height: 160px; }
            #cp-match-section { padding: 20px; }
        }

    </style>
</head>
<body>

    <div id="quiz-container">
        <!-- 卡券验证屏幕 -->
        <div id="coupon-screen" class="screen">
            <h2>解锁动物塑测试</h2>
            <p>请输入您的专属卡券密码以开始测试。</p>
            <input type="text" id="coupon-input" placeholder="输入卡券密码" autocomplete="off">
            <button id="verify-btn">验证并开始测试</button>
            <p id="coupon-error"></p>
            <div class="screen-footer">珊瑚鲤鱼 · 动物塑</div>
        </div>

        <!-- 开始屏幕 -->
        <div id="start-screen" class="screen hidden">
            <h1>动物塑</h1>
            <h2>你的动物塑形象</h2>
            <p class="start-description">预警：个人能力有限，测试仅供参考。</p>
            <p style="text-align: center; color: var(--secondary-text); margin-bottom: 25px;">由 珊瑚鲤鱼 制作</p>
            <button id="start-btn" class="start-button">开始测试</button>
            <div class="screen-footer">动物塑</div>
        </div>

        <!-- 答题屏幕 -->
        <div id="quiz-screen" class="screen hidden">
            <button id="back-btn" class="back-button">← 上一题</button>
            <div id="progress-bar-container">
                <div id="progress-bar"></div>
            </div>
            <h3 id="question-title" class="question-title"></h3>
            <ul id="option-list" class="option-list"></ul>
            <div class="screen-footer">问题 <span id="question-counter">1</span>/60</div>
        </div>
        
        <!-- 结果屏幕 -->
        <div id="result-screen" class="screen hidden">
            <h2>你的动物塑原型是：</h2>
            <h3 id="result-animal"></h3>
            <p id="result-description"></p>
            
            <div id="result-stats">
                <h4 class="stats-title">你的特质分析</h4>
                <div class="stats-chart"></div>
                <div class="stat-item"><span class="stat-label">力量 (STR)</span><div class="stat-bar-container"><div class="stat-bar" id="str-bar"></div></div><span class="stat-value" id="str-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">敏捷 (AGI)</span><div class="stat-bar-container"><div class="stat-bar" id="agi-bar"></div></div><span class="stat-value" id="agi-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">魅力 (AES)</span><div class="stat-bar-container"><div class="stat-bar" id="aes-bar"></div></div><span class="stat-value" id="aes-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">社交 (COM)</span><div class="stat-bar-container"><div class="stat-bar" id="com-bar"></div></div><span class="stat-value" id="com-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">安全 (SEC)</span><div class="stat-bar-container"><div class="stat-bar" id="sec-bar"></div></div><span class="stat-value" id="sec-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">独处 (SOL)</span><div class="stat-bar-container"><div class="stat-bar" id="sol-bar"></div></div><span class="stat-value" id="sol-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">主导 (DOM)</span><div class="stat-bar-container"><div class="stat-bar" id="dom-bar"></div></div><span class="stat-value" id="dom-value">0%</span></div>
            </div>
            
            <div id="cp-match-section">
                <div class="cp-title">
                    <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                    你的灵魂伴侣
                </div>
                <p id="cp-reason"></p>
                <p class="cp-footer">那个与你完美共鸣的灵魂是：<strong id="cp-animal"></strong></p>
            </div>

            <div class="button-group">
                <button id="restart-btn" class="restart-button">再测一次</button>
                <button id="browse-btn" class="browse-button">浏览所有动物塑</button>
            </div>
            <div class="screen-footer">动物塑解析 · 完成</div>
        </div>

        <!-- 动物图鉴屏幕 -->
        <div id="animal-guide-screen" class="screen hidden">
            <button id="back-to-result-btn" class="back-button">← 返回结果</button>
            <h2>动物塑图鉴</h2>
            <p>这里是所有可能的动物塑原型及其解析：</p>
            <div id="animal-guide"></div>
            <div class="screen-footer">完整图鉴</div>
        </div>

        <!-- 加载屏幕 -->
        <div id="loading-screen" class="screen hidden">
            <div style="text-align: center;">
                <div class="loader"></div>
                <p>正在解析你的动物塑形象...</p>
            </div>
        </div>
    </div>
    
    <script src="data.js"></script>
    
    <script>
    // DOM元素
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const animalGuideScreen = document.getElementById('animal-guide-screen');
    const couponScreen = document.getElementById('coupon-screen');

    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const backBtn = document.getElementById('back-btn');
    const browseBtn = document.getElementById('browse-btn');
    const backToResultBtn = document.getElementById('back-to-result-btn');
    const verifyBtn = document.getElementById('verify-btn');
    const couponInput = document.getElementById('coupon-input');
    const couponError = document.getElementById('coupon-error');
    
    const questionTitle = document.getElementById('question-title');
    const optionList = document.getElementById('option-list');
    const progressBar = document.getElementById('progress-bar');
    const questionCounter = document.getElementById('question-counter');
    const animalGuide = document.getElementById('animal-guide');
    
    const resultAnimal = document.getElementById('result-animal');
    const resultDescription = document.getElementById('result-description');
    
    const cpReason = document.getElementById('cp-reason');
    const cpAnimal = document.getElementById('cp-animal');

    const dimensionKeys = ["DOM", "STR", "COM", "SOL", "AGI", "SEC", "AES"];
    
    // 使用 data.js 中的核心变量
    // let currentQuestionIndex, scores, selectedOptions, isProcessing;

    function initQuizState() {
        currentQuestionIndex = 0;
        scores = {};
        dimensionKeys.forEach(key => scores[key] = 0);
        selectedOptions = [];
        isProcessing = false;
    }
    
    function initAnimalGuide() {
        animalGuide.innerHTML = '';
        Object.keys(animalArchetypes).forEach(animal => {
            const card = document.createElement('div');
            card.className = 'animal-card';
            card.innerHTML = `
                <h3>【 ${animal} 】</h3>
                <p>${animalArchetypes[animal].desc}</p>
            `;
            animalGuide.appendChild(card);
        });
    }

    function startQuiz() {
        if (isProcessing) return;
        isProcessing = true;
        
        initQuizState();
        
        const screensToHide = [startScreen, resultScreen, animalGuideScreen, loadingScreen, couponScreen];
        screensToHide.forEach(screen => screen.classList.add('hidden'));
        
        quizScreen.classList.remove('hidden');
        quizScreen.classList.remove('fade-out');
        showQuestion();
        isProcessing = false;
    }

    function showQuestion() {
        if (currentQuestionIndex >= quizData.length) {
            showResult();
            return;
        }

        const currentQuestion = quizData[currentQuestionIndex];
        questionTitle.innerHTML = `${currentQuestionIndex + 1}. ${currentQuestion.question}`;
        questionCounter.textContent = `${currentQuestionIndex + 1}/${quizData.length}`;
        backBtn.style.visibility = currentQuestionIndex > 0 ? 'visible' : 'hidden';
        
        optionList.innerHTML = '';
        ['A', 'B', 'C', 'D'].forEach(key => {
            if (currentQuestion.options[key]) {
                const li = document.createElement('li');
                li.className = 'option-item';
                if (selectedOptions[currentQuestionIndex] === key) {
                    li.classList.add('selected');
                }
                li.innerHTML = `<span class="option-prefix">${key}</span><span class="option-text">${currentQuestion.options[key]}</span>`;
                li.addEventListener('click', () => selectOption(key, li));
                optionList.appendChild(li);
            }
        });
        
        updateProgressBar();
    }
    
    function updateProgressBar() {
        const progress = (currentQuestionIndex / quizData.length) * 100;
        progressBar.style.width = `${progress}%`;
    }

    function selectOption(optionKey, element) {
        if (isProcessing) return;
        isProcessing = true;

        selectedOptions[currentQuestionIndex] = optionKey;
        
        const questionScores = scoreMap[currentQuestionIndex][optionKey];
        for (const dim in questionScores) {
            scores[dim] += questionScores[dim];
        }
        
        document.querySelectorAll('.option-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        
        setTimeout(() => {
            quizScreen.classList.add('fade-out');
            setTimeout(() => {
                currentQuestionIndex++;
                quizScreen.classList.remove('fade-out');
                showQuestion();
                isProcessing = false;
            }, 400);
        }, 500);
    }
    
    function goBack() {
        if (isProcessing || currentQuestionIndex <= 0) return;
        isProcessing = true;
        
        const lastQuestionIndex = currentQuestionIndex - 1;
        const lastOption = selectedOptions[lastQuestionIndex];
        if (lastOption) {
            const questionScores = scoreMap[lastQuestionIndex][lastOption];
            for (const dim in questionScores) {
                scores[dim] -= questionScores[dim];
            }
        }
        
        quizScreen.classList.add('fade-out');
        
        setTimeout(() => {
            currentQuestionIndex--;
            quizScreen.classList.remove('fade-out');
            showQuestion();
            isProcessing = false;
        }, 400);
    }
    
    function showAllAnimals() {
        resultScreen.classList.add('hidden');
        animalGuideScreen.classList.remove('hidden');
    }
    
    function backToResult() {
        animalGuideScreen.classList.add('hidden');
        resultScreen.classList.remove('hidden');
    }
    
    function verifyCoupon() {
        const inputCode = couponInput.value.toUpperCase().trim();
        couponError.textContent = ''; // 清空错误信息

        if (!inputCode) {
            couponError.textContent = '请输入卡券密码。';
            return;
        }

        // 使用 data.js 中的 validateCoupon 函数
        const result = validateCoupon(inputCode);
        
        if (result.success) {
            // 找到对应的卡券并标记为已使用
            const coupon = validCouponCodes.find(c => c.code === inputCode);
            if (coupon) {
                coupon.used = true;
            }
            
            couponScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            couponError.textContent = '';
            couponInput.value = '';
        } else {
            couponError.textContent = result.message || '卡券验证失败，请重试。';
        }
    }

    function displayResultStats(finalScores) {
        const maxPossibleScore = quizData.length * 2;
        
        const stats = {};
        dimensionKeys.forEach(key => {
            const value = finalScores[key] || 0;
            const percentage = maxPossibleScore > 0 ? Math.round((value / maxPossibleScore) * 100 * dimensionKeys.length * 0.7) : 0;
            stats[key] = Math.min(100, Math.max(0, percentage)); // 限制在 0-100
        });
        
        dimensionKeys.forEach(key => {
            const barElement = document.getElementById(`${key.toLowerCase()}-bar`);
            const valueElement = document.getElementById(`${key.toLowerCase()}-value`);
            
            setTimeout(() => {
                if(barElement) barElement.style.width = `${stats[key]}%`;
                if(valueElement) valueElement.textContent = `${stats[key]}%`;
            }, 300);
        });
        
        const chart = document.querySelector('.stats-chart');
        chart.innerHTML = '';
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute('viewBox', '0 0 200 200');
        chart.appendChild(svg);
        const centerX = 100, centerY = 100, radius = 80, numAxes = dimensionKeys.length;
        
        for(let i = 4; i > 0; i--) {
            const points = dimensionKeys.map((key, j) => {
                const angle = (j / numAxes) * 2 * Math.PI - Math.PI / 2;
                const r = radius * (i / 4);
                return `${centerX + r * Math.cos(angle)},${centerY + r * Math.sin(angle)}`;
            }).join(' ');
            const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            polygon.setAttribute('points', points);
            polygon.setAttribute('fill', 'transparent');
            polygon.setAttribute('stroke', 'rgba(226, 232, 240, 0.7)');
            svg.appendChild(polygon);
        }

        const points = dimensionKeys.map((key, i) => {
            const angle = (i / numAxes) * 2 * Math.PI - Math.PI / 2;
            const value = stats[key] / 100;
            const r = radius * value;
            return `${centerX + r * Math.cos(angle)},${centerY + r * Math.sin(angle)}`;
        }).join(' ');
        
        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute('points', points);
        polygon.setAttribute('fill', 'rgba(107, 70, 193, 0.4)');
        polygon.setAttribute('stroke', 'rgba(107, 70, 193, 0.9)');
        polygon.setAttribute('stroke-width', '2');
        polygon.style.transition = 'all 1s ease-out';
        polygon.style.opacity = '0';
        svg.appendChild(polygon);
        
        setTimeout(() => { polygon.style.opacity = '1'; }, 500);
    }
    
    function findBestCP(userAnimalName, userVector) {
        let bestCP = null;
        let maxScore = -Infinity;

        Object.keys(animalArchetypes).forEach(cpAnimalName => {
            if (cpAnimalName === userAnimalName) return;

            const cpVector = animalArchetypes[cpAnimalName].vector;
            let score = 0;

            score += 20 - Math.abs(userVector.SOL - (5 - cpVector.SOL)); 
            score += 20 - Math.abs(userVector.COM - (5 - cpVector.COM));
            score += Math.abs(userVector.SEC - cpVector.DOM) * 3;
            score += Math.min(userVector.AES, cpVector.AES) * 2;
            score += Math.min(userVector.STR, cpVector.STR) * 2; 

            if (score > maxScore) {
                maxScore = score;
                bestCP = cpAnimalName;
            }
        });

        return bestCP || '水豚';
    }

    function showResult() {
        quizScreen.classList.add('hidden');
        loadingScreen.classList.remove('hidden');
        
        setTimeout(() => {
            const userTotalScore = dimensionKeys.reduce((sum, key) => sum + scores[key], 0);
            const normalizedScores = {};
            
            if (userTotalScore === 0) {
                dimensionKeys.forEach(key => normalizedScores[key] = 0);
            } else {
                dimensionKeys.forEach(key => {
                    normalizedScores[key] = (scores[key] / userTotalScore) * ANIMAL_ARCHETYPE_TOTAL;
                });
            }

            let bestMatchAnimal = '水豚';
            let minDifference = Infinity;

            Object.keys(animalArchetypes).forEach(animalName => {
                const animalVector = animalArchetypes[animalName].vector;
                let currentDifference = 0;
                dimensionKeys.forEach(key => {
                    const diff = (normalizedScores[key] || 0) - (animalVector[key] || 0);
                    currentDifference += diff * diff;
                });
                
                if (currentDifference < minDifference) {
                    minDifference = currentDifference;
                    bestMatchAnimal = animalName;
                }
            });

            const resultData = animalArchetypes[bestMatchAnimal];
            resultAnimal.textContent = `【 ${bestMatchAnimal} 】`;
            resultDescription.textContent = resultData.desc;
            
            displayResultStats(scores);
            
            const userVector = resultData.vector;
            const bestCPName = findBestCP(bestMatchAnimal, userVector);
            const cpData = animalArchetypes[bestCPName];
            
            cpReason.textContent = cpData.getCpInterpretation(bestMatchAnimal, bestCPName);
            cpAnimal.textContent = `【 ${bestCPName} 】`;

            loadingScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            isProcessing = false;
        }, 1500);
    }

    // 事件监听器
    startBtn.addEventListener('click', startQuiz);
    restartBtn.addEventListener('click', startQuiz);
    backBtn.addEventListener('click', goBack);
    browseBtn.addEventListener('click', showAllAnimals);
    backToResultBtn.addEventListener('click', backToResult);
    verifyBtn.addEventListener('click', verifyCoupon);
    
    couponInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verifyCoupon();
        }
    });

    // 初始化
    window.addEventListener('DOMContentLoaded', () => {
        if (typeof quizData === 'undefined' || typeof scoreMap === 'undefined' || typeof animalArchetypes === 'undefined' || typeof validCouponCodes === 'undefined') {
            document.body.innerHTML = '<div style="padding: 40px; text-align: center; color: red;">错误：未能加载核心数据文件 (data.js)。请确保该文件与HTML文件在同一目录下。</div>';
            return;
        }
        initQuizState();
        initAnimalGuide();
    });
    </script>
</body>
</html>
