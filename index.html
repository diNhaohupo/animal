<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹ä¸€æµ‹ä½ çš„åŠ¨ç‰©å¡‘</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@500;700&display=swap');

        :root {
            --bg-color: #f8f9fc;
            --primary-text: #2d3748;
            --secondary-text: #4a5568;
            --accent-color: #6b46c1;
            --accent-light: #805ad5;
            --card-bg: #ffffff;
            --card-bg-light: #f7fafc;
            --border-color: #e2e8f0;
            --hover-bg: #f6f6ff;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --shadow-glow: 0 0 15px rgba(107, 70, 193, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            min-height: 100vh;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(107, 70, 193, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 70%, rgba(107, 70, 193, 0.03) 0%, transparent 30%);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            transition: background-color 1s ease;
        }

        #quiz-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--card-bg);
            border-radius: 24px;
            box-shadow: var(--shadow), var(--shadow-glow);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .screen {
            padding: 40px;
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); filter: blur(5px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        h1, h2, h3 { color: var(--primary-text); margin-bottom: 16px; position: relative; }
        
        h1 { 
            font-family: 'Noto Serif SC', serif;
            font-size: 2.2em; 
            text-align: center;
            background: linear-gradient(90deg, var(--accent-color), var(--primary-text));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 20px;
        }

        h2 { 
            font-size: 1.6em; 
            color: var(--accent-color); 
            margin-top: 0;
            text-align: center;
            font-weight: 500;
        }

        h3.question-title { 
            text-align: left; 
            font-size: 1.3em; 
            margin-bottom: 30px; 
            line-height: 1.8;
            padding-left: 4px;
            border-left: 3px solid var(--accent-color);
        }

        p { color: var(--secondary-text); line-height: 1.8; margin-bottom: 30px; font-size: 1.05em; }

        .start-button, .restart-button, .browse-button, .back-button, #verify-btn {
            display: block;
            width: 220px;
            margin: 30px auto 0;
            padding: 16px 20px;
            background: linear-gradient(45deg, var(--accent-color), var(--accent-light));
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(107, 70, 193, 0.2);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .start-button:disabled, .restart-button:disabled, .browse-button:disabled, .back-button:disabled, #verify-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .back-button {
            width: auto;
            padding: 10px 20px;
            margin: 0 0 20px 0;
            background: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .button-group { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }

        .option-list { list-style: none; padding: 0; margin: 0 0 20px 0; flex-grow: 1; }

        .option-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 16px;
            padding: 20px 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .option-item:hover { background-color: var(--hover-bg); border-color: var(--accent-color); }
        .option-item.selected { background-color: rgba(107, 70, 193, 0.08); border-color: var(--accent-light); }

        #progress-bar-container { width: 100%; background-color: rgba(226, 232, 240, 0.5); height: 8px; border-radius: 4px; margin-bottom: 30px; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-color), var(--accent-light)); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        .hidden { display: none; }
        
        .screen-footer { text-align: center; font-size: 0.9em; color: var(--secondary-text); margin-top: 40px; opacity: 0.7; }
        
        .loader { width: 48px; height: 48px; border: 3px solid var(--accent-color); border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; margin: 20px auto; }
        @keyframes rotation { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #animal-guide { max-height: 600px; overflow-y: auto; padding-right: 15px; }

        #coupon-screen { text-align: center; }
        #coupon-input { width: 250px; padding: 12px; margin: 20px auto 20px; display: block; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; text-align: center; letter-spacing: 2px; }
        #coupon-error { color: #e53e3e; text-align: center; margin-top: 15px; min-height: 1.2em; display: block; }
        
        /* ç»“æœé¡µæ ·å¼ */
        #result-screen p, #animal-guide-screen .animal-card p { white-space: pre-wrap; }
        #result-screen p h3, #animal-guide-screen .animal-card p h3 {
            font-size: 1.1em;
            color: var(--accent-color);
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .screen { padding: 25px 20px; }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }
            .button-group { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>

    <div id="quiz-container">
        <!-- å¡åˆ¸éªŒè¯å±å¹• (é»˜è®¤æ˜¾ç¤º) -->
        <div id="coupon-screen" class="screen">
            <h2>è§£é”åŠ¨ç‰©å¡‘æµ‹è¯•</h2>
            <p>è¯·è¾“å…¥æ‚¨çš„ä¸“å±å¡åˆ¸å¯†ç ä»¥å¼€å§‹æµ‹è¯•ã€‚</p>
            <input type="text" id="coupon-input" placeholder="è¾“å…¥å¡åˆ¸å¯†ç " autocomplete="off">
            <button id="verify-btn">éªŒè¯å¹¶å¼€å§‹æµ‹è¯•</button>
            <p id="coupon-error"></p>
            <div class="screen-footer">çŠç‘šé²¤é±¼ Â· åŠ¨ç‰©å¡‘</div>
        </div>

        <!-- å¼€å§‹å±å¹• (é»˜è®¤éšè—) -->
        <div id="start-screen" class="screen hidden">
            <h1>åŠ¨ç‰©å¡‘</h1>
            <h2>ä½ çš„åŠ¨ç‰©å¡‘å½¢è±¡</h2>
            <p>é¢„è­¦ï¼šä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œæµ‹è¯•ä»…ä¾›å‚è€ƒã€‚</p>
            <p style="text-align: center; color: var(--secondary-text); margin-bottom: 25px;">ç”± çŠç‘šé²¤é±¼ åˆ¶ä½œ</p>
            <button id="start-btn" class="start-button">å¼€å§‹æµ‹è¯•</button>
            <div class="screen-footer">åŠ¨ç‰©å¡‘</div>
        </div>

        <!-- ç­”é¢˜å±å¹• (é»˜è®¤éšè—) -->
        <div id="quiz-screen" class="screen hidden">
            <button id="back-btn" class="back-button">â† ä¸Šä¸€é¢˜</button>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
            <h3 id="question-title" class="question-title"></h3>
            <ul id="option-list" class="option-list"></ul>
            <div class="screen-footer">é—®é¢˜ <span id="question-counter">1</span>/60</div>
        </div>
        
        <!-- ç»“æœå±å¹• (é»˜è®¤éšè—) -->
        <div id="result-screen" class="screen hidden">
            <h2>ä½ çš„åŠ¨ç‰©å¡‘åŸå‹æ˜¯ï¼š</h2>
            <h3 id="result-animal"></h3>
            <p id="result-description"></p>
            <div id="cp-match-section">
                <!-- CPå†…å®¹å°†åŠ¨æ€å¡«å…¥ -->
            </div>
            <div class="button-group">
                <button id="restart-btn" class="restart-button">å†æµ‹ä¸€æ¬¡</button>
                <button id="browse-btn" class="browse-button">æµè§ˆæ‰€æœ‰åŠ¨ç‰©å¡‘</button>
            </div>
        </div>

        <!-- åŠ¨ç‰©å›¾é‰´å±å¹• (é»˜è®¤éšè—) -->
        <div id="animal-guide-screen" class="screen hidden">
            <button id="back-to-result-btn" class="back-button">â† è¿”å›ç»“æœ</button>
            <h2>åŠ¨ç‰©å¡‘å›¾é‰´</h2>
            <div id="animal-guide"></div>
        </div>

        <!-- åŠ è½½å±å¹• (é»˜è®¤éšè—) -->
        <div id="loading-screen" class="screen hidden">
            <div style="text-align: center;">
                <div class="loader"></div>
                <p>æ­£åœ¨è§£æä½ çš„åŠ¨ç‰©å¡‘å½¢è±¡...</p>
            </div>
        </div>
    </div>
    
    <script src="data.js"></script>
    
    <script>
    // DOMå…ƒç´ 
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const animalGuideScreen = document.getElementById('animal-guide-screen');
    const couponScreen = document.getElementById('coupon-screen');

    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const backBtn = document.getElementById('back-btn');
    const browseBtn = document.getElementById('browse-btn');
    const backToResultBtn = document.getElementById('back-to-result-btn');
    const verifyBtn = document.getElementById('verify-btn');
    const couponInput = document.getElementById('coupon-input');
    const couponError = document.getElementById('coupon-error');
    
    const questionTitle = document.getElementById('question-title');
    const optionList = document.getElementById('option-list');
    const progressBar = document.getElementById('progress-bar');
    const questionCounter = document.getElementById('question-counter');
    const animalGuide = document.getElementById('animal-guide');
    const resultDescription = document.getElementById('result-description');
    
    // åˆå§‹åŒ–å‡½æ•°
    function initQuizState() {
        currentQuestionIndex = 0;
        scores = {};
        dimensionKeys.forEach(key => scores[key] = 0);
        selectedOptions = [];
        isProcessing = false;
    }

    function formatDescription(text) {
        return text.replace(/### (.*?)\n/g, '<h3>\$1</h3>');
    }
    
    function initAnimalGuide() {
        animalGuide.innerHTML = '';
        Object.keys(animalArchetypes).forEach(animal => {
            const card = document.createElement('div');
            card.className = 'animal-card';
            card.innerHTML = `
                <h3>ã€ ${animal} ã€‘</h3>
                <p>${formatDescription(animalArchetypes[animal].desc)}</p>
            `;
            animalGuide.appendChild(card);
        });
    }

    // æ ¸å¿ƒæµç¨‹å‡½æ•°
    function startQuiz() {
        if (isProcessing) return;
        isProcessing = true;
        initQuizState();
        [startScreen, resultScreen, animalGuideScreen, couponScreen].forEach(s => s.classList.add('hidden'));
        quizScreen.classList.remove('hidden');
        showQuestion();
        isProcessing = false;
    }

    function showQuestion() {
        if (currentQuestionIndex >= quizData.length) {
            showResult();
            return;
        }

        const q = quizData[currentQuestionIndex];
        questionTitle.innerHTML = `${currentQuestionIndex + 1}. ${q.question}`;
        questionCounter.textContent = `${currentQuestionIndex + 1}/${quizData.length}`;
        backBtn.style.visibility = currentQuestionIndex > 0 ? 'visible' : 'hidden';
        
        optionList.innerHTML = '';
        Object.keys(q.options).forEach(key => {
            const li = document.createElement('li');
            li.className = 'option-item';
            if (selectedOptions[currentQuestionIndex] === key) li.classList.add('selected');
            li.innerHTML = `<span class="option-prefix">${key}</span><span class="option-text">${q.options[key]}</span>`;
            li.addEventListener('click', () => selectOption(key));
            optionList.appendChild(li);
        });
        
        updateProgressBar();
    }

    function selectOption(optionKey) {
        if (isProcessing) return;
        isProcessing = true;
        selectedOptions[currentQuestionIndex] = optionKey;
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
            isProcessing = false;
        }, 300);
    }
    
    function goBack() {
        if (isProcessing || currentQuestionIndex <= 0) return;
        isProcessing = true;
        currentQuestionIndex--;
        showQuestion();
        isProcessing = false;
    }

    function calculateScores() {
        initQuizState(); // åªé‡ç½®åˆ†æ•°ï¼Œä¸é‡ç½®é¢˜ç›®ç´¢å¼•
        for (let i = 0; i < selectedOptions.length; i++) {
            const option = selectedOptions[i];
            if (option) {
                const questionScores = scoreMap[i][option];
                for (const dim in questionScores) {
                    scores[dim] = (scores[dim] || 0) + questionScores[dim];
                }
            }
        }
    }

    function showResult() {
        quizScreen.classList.add('hidden');
        loadingScreen.classList.remove('hidden');
        
        calculateScores();

        setTimeout(() => {
            let bestMatchAnimal = 'æ°´è±š';
            let minDifference = Infinity;

            Object.keys(animalArchetypes).forEach(animalName => {
                const animalVector = animalArchetypes[animalName].vector;
                let currentDifference = 0;
                dimensionKeys.forEach(key => {
                    const diff = (scores[key] || 0) - (animalVector[key] || 0);
                    currentDifference += diff * diff;
                });
                if (currentDifference < minDifference) {
                    minDifference = currentDifference;
                    bestMatchAnimal = animalName;
                }
            });

            document.getElementById('result-animal').textContent = `ã€ ${bestMatchAnimal} ã€‘`;
            resultDescription.innerHTML = formatDescription(animalArchetypes[bestMatchAnimal].desc);
            
            loadingScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
        }, 1500);
    }

    function showAllAnimals() {
        resultScreen.classList.add('hidden');
        animalGuideScreen.classList.remove('hidden');
    }
    
    function backToResult() {
        animalGuideScreen.classList.add('hidden');
        resultScreen.classList.remove('hidden');
    }
    
    // ã€ã€ã€ å¡åˆ¸éªŒè¯æ ¸å¿ƒå‡½æ•° ã€‘ã€‘ã€‘
    async function verifyCoupon() {
        const inputCode = couponInput.value.toUpperCase().trim();
        couponError.textContent = ''; 

        if (!inputCode) {
            couponError.textContent = 'è¯·è¾“å…¥å¡åˆ¸å¯†ç ã€‚';
            return;
        }

        // --- ğŸ“ è¯·åœ¨è¿™é‡Œå¡«å…¥æ‚¨è‡ªå·±çš„ä¿¡æ¯ ğŸ“ ---
        const YOUR_API_TOKEN = 'uskDUbM4CPy64coNePFs9Uk'; // âš ï¸ æ›¿æ¢æˆæ‚¨åœ¨ç¬¬ä¸‰æ­¥è·å–çš„API Token
        const YOUR_DATASHEET_ID = 'dstXlyh1k5ssc91ha5'; // âš ï¸ æ›¿æ¢æˆæ‚¨åœ¨ç¬¬å››æ­¥è·å–çš„æ•°æ®è¡¨ID
        // ------------------------------------

        if (YOUR_API_TOKEN === 'olkxxxxxxxxxxxxxxxxx' || YOUR_DATASHEET_ID === 'dstxxxxxxxxxxxxxxxxx') {
            couponError.textContent = 'é”™è¯¯ï¼šè¯·å…ˆåœ¨HTMLä»£ç ä¸­é…ç½®API Tokenå’Œæ•°æ®è¡¨IDã€‚';
            return;
        }

        verifyBtn.disabled = true;
        verifyBtn.textContent = 'éªŒè¯ä¸­...';

        try {
            const queryUrl = `https://api.vika.cn/fusion/v1/datasheets/${YOUR_DATASHEET_ID}/records?filterByFormula=({code}="${inputCode}")`;
            
            const queryResponse = await fetch(queryUrl, {
                headers: { 'Authorization': `Bearer ${YOUR_API_TOKEN}` }
            });

            if (!queryResponse.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${queryResponse.statusText}`);

            const queryResult = await queryResponse.json();

            if (!queryResult.success || queryResult.data.records.length === 0) {
                couponError.textContent = 'å¡åˆ¸ä¸å­˜åœ¨æˆ–æ— æ•ˆ';
            } else {
                const record = queryResult.data.records[0];
                if (record.fields.used) {
                    couponError.textContent = 'æ­¤å¡åˆ¸å·²è¢«ä½¿ç”¨';
                } else {
                    const updateUrl = `https://api.vika.cn/fusion/v1/datasheets/${YOUR_DATASHEET_ID}/records`;
                    await fetch(updateUrl, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${YOUR_API_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            records: [{ recordId: record.recordId, fields: { used: true } }]
                        })
                    });
                    
                    couponScreen.classList.add('hidden');
                    startScreen.classList.remove('hidden');
                }
            }
        } catch (error) {
            console.error('éªŒè¯å‡ºé”™:', error);
            couponError.textContent = 'éªŒè¯æœåŠ¡å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚';
        } finally {
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'éªŒè¯å¹¶å¼€å§‹æµ‹è¯•';
        }
    }

    // äº‹ä»¶ç›‘å¬å™¨
    startBtn.addEventListener('click', startQuiz);
    restartBtn.addEventListener('click', () => { // å†æµ‹ä¸€æ¬¡è¿”å›å¡åˆ¸è¾“å…¥é¡µ
        [startScreen, resultScreen, quizScreen, animalGuideScreen].forEach(s => s.classList.add('hidden'));
        couponScreen.classList.remove('hidden');
    });
    backBtn.addEventListener('click', goBack);
    browseBtn.addEventListener('click', showAllAnimals);
    backToResultBtn.addEventListener('click', backToResult);
    verifyBtn.addEventListener('click', verifyCoupon);
    couponInput.addEventListener('keypress', e => { if (e.key === 'Enter') verifyCoupon(); });

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
        if (typeof quizData === 'undefined') {
            document.body.innerHTML = '<div style="padding:40px;text-align:center;color:red;">é”™è¯¯ï¼šæœªèƒ½åŠ è½½data.jsã€‚</div>';
            return;
        }
        initQuizState();
        initAnimalGuide();
    });
    </script>
</body>
</html>
