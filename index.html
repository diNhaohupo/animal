<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测一测你的动物塑</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@500;700&display=swap');
        :root{--bg-color:#f8f9fc;--primary-text:#2d3748;--secondary-text:#4a5568;--accent-color:#6b46c1;--accent-light:#805ad5;--card-bg:#fff;--border-color:#e2e8f0;--hover-bg:#f6f6ff;--shadow:0 8px 30px rgba(0,0,0,.08)}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Noto Sans SC',sans-serif;background-color:var(--bg-color);color:var(--primary-text);min-height:100vh;padding:20px;display:flex;justify-content:center;align-items:center}
        #quiz-container{width:100%;max-width:700px;background-color:var(--card-bg);border-radius:24px;box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--border-color)}
        .screen{padding:40px;animation:fadeIn .8s cubic-bezier(.4,0,.2,1);min-height:450px;display:flex;flex-direction:column}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        h1,h2,h3,h4{color:var(--primary-text);margin-bottom:16px}
        h1{font-family:'Noto Serif SC',serif;font-size:2.2em;text-align:center;background:linear-gradient(90deg,var(--accent-color),var(--primary-text));-webkit-background-clip:text;background-clip:text;color:transparent;margin-bottom:20px}
        h2{font-size:1.6em;color:var(--accent-color);text-align:center;font-weight:500}
        h3.question-title{font-size:1.3em;margin-bottom:30px;line-height:1.8}
        p{color:var(--secondary-text);line-height:1.8;margin-bottom:30px;font-size:1.05em}
        .start-button,.restart-button,.browse-button,.back-button,#verify-btn{display:block;width:220px;margin:30px auto 0;padding:16px 20px;background:linear-gradient(45deg,var(--accent-color),var(--accent-light));color:#fff;border:none;border-radius:50px;font-size:1.1em;font-weight:500;cursor:pointer;transition:all .3s ease}
        .start-button:disabled,#verify-btn:disabled{background:#ccc;cursor:not-allowed}
        .back-button{width:auto;padding:10px 20px;margin:0 0 20px 0;background:0 0;color:var(--accent-color);border:1px solid var(--accent-color)}
        .button-group{display:flex;justify-content:center;gap:15px;margin-top:30px}
        .option-list{list-style:none;padding:0;margin:0;flex-grow:1}
        .option-item{background-color:var(--card-bg);border:1px solid var(--border-color);border-radius:16px;margin-bottom:16px;padding:20px 25px;cursor:pointer;transition:all .3s ease; display: flex; align-items: center;}
        .option-item:hover{background-color:var(--hover-bg);border-color:var(--accent-color)}
        .option-item.selected{background-color:rgba(107,70,193,.08);border-color:var(--accent-light)}
        .option-prefix{margin-right: 15px; font-weight: bold; color: var(--accent-color); font-size: 1.2em;}
        #progress-bar-container{width:100%;background-color:#e2e8f0;height:8px;border-radius:4px;margin-bottom:30px}
        #progress-bar{width:0;height:100%;background:var(--accent-color);transition:width .6s ease}
        .hidden{display:none}
        .screen-footer{text-align:center;font-size:.9em;color:var(--secondary-text);margin-top:auto;padding-top:20px}
        .loader{width:48px;height:48px;border:3px solid var(--accent-color);border-bottom-color:transparent;border-radius:50%;display:block;margin:80px auto;animation:rotation 1s linear infinite}
        @keyframes rotation{from{transform:rotate(0)}to{transform:rotate(360deg)}}
        #coupon-screen{text-align:center}
        #coupon-input{width:250px;padding:12px;margin:20px auto;display:block;border:1px solid var(--border-color);border-radius:8px;font-size:16px;text-align:center}
        #coupon-error{color:#e53e3e;min-height:1.2em}
        #result-screen #result-description, #animal-guide-screen .animal-card p{white-space:pre-wrap}
        #result-screen #result-description h3, #animal-guide-screen .animal-card p h3{font-size:1.1em;color:var(--accent-color);margin-top:20px;margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid var(--border-color)}
        .animal-card{background-color:#f7fafc;border-radius:16px;border:1px solid #e2e8f0;padding:20px;margin-bottom:20px}
        .animal-card h3{color:var(--accent-color)}
        #animal-guide{max-height:600px;overflow-y:auto;padding-right:15px}
        
        /* === [恢复] 数据可视化样式 === */
        #result-stats{margin:30px auto;max-width:90%;padding:20px;background-color:rgba(247,250,252,.8);border-radius:16px;border:1px solid rgba(226,232,240,.8)}
        .stats-title{font-size:1.2em;color:var(--accent-color);margin-bottom:15px;text-align:center}
        .stats-chart{height:200px;margin-bottom:20px;position:relative;overflow:hidden}
        .stat-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding:8px 10px;border-radius:8px;background-color:rgba(255,255,255,.5)}
        .stat-label{font-weight:500}
        .stat-bar-container{height:10px;background-color:rgba(226,232,240,.5);border-radius:5px;flex-grow:1;margin:0 15px;overflow:hidden}
        .stat-bar{width:0%;height:100%;background:linear-gradient(90deg,var(--accent-color),var(--accent-light));border-radius:5px;transition:width 1s ease-out}
        .stat-value{min-width:40px;text-align:right;font-weight:500}
        
        /* === [恢复] CP匹配区样式 === */
        #cp-match-section{margin:40px auto 0;max-width:90%;padding:25px 30px;background:linear-gradient(135deg,rgba(233,213,255,.2),rgba(250,233,255,.3));border-radius:16px;border:1px solid rgba(107,70,193,.2);box-shadow:0 4px 20px rgba(107,70,193,.05)}
        #cp-match-section .cp-title{color:var(--accent-color);font-size:1.3em;font-weight:700;text-align:center;margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:10px}
        #cp-match-section .cp-title svg{width:24px;height:24px;fill:#c084fc;animation:heartbeat 1.5s ease-in-out infinite}
        @keyframes heartbeat{0%{transform:scale(1)}14%{transform:scale(1.3)}28%{transform:scale(1)}42%{transform:scale(1.3)}70%{transform:scale(1)}}
        #cp-reason{margin-bottom:20px;padding:0;background-color:transparent;border:none;font-size:1.05em;line-height:1.9;color:var(--secondary-text)}
        #cp-animal{font-weight:700;color:var(--accent-light);font-size:1.2em}
        
        @media (max-width:600px){body{padding:10px}.screen{padding:25px 20px}.button-group{flex-direction:column;align-items:center}}
    </style>
</head>
<body>

    <div id="quiz-container">
        <div id="coupon-screen" class="screen">
            <h2>解锁动物塑测试</h2>
            <p>请输入您的专属卡券密码以开始测试。</p>
            <input type="text" id="coupon-input" placeholder="输入卡券密码" autocomplete="off">
            <button id="verify-btn">验证并开始测试</button>
            <p id="coupon-error"></p>
            <div class="screen-footer">珊瑚鲤鱼 · 动物塑</div>
        </div>

        <div id="start-screen" class="screen hidden">
            <h1>动物塑</h1>
            <p>预警：个人能力有限，测试仅供参考。</p>
            <button id="start-btn" class="start-button">开始测试</button>
        </div>

        <div id="quiz-screen" class="screen hidden">
            <button id="back-btn" class="back-button">← 上一题</button>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
            <h3 id="question-title" class="question-title"></h3>
            <ul id="option-list" class="option-list"></ul>
            <div class="screen-footer">问题 <span id="question-counter">1</span> / 60</div>
        </div>
        
        <div id="result-screen" class="screen hidden">
            <h2>你的动物塑原型是：</h2>
            <h3 id="result-animal"></h3>
            <p id="result-description"></p>
            
            <!-- === [恢复] 数据可视化UI结构 === -->
            <div id="result-stats">
                <h4 class="stats-title">你的特质分析</h4>
                <div class="stats-chart"></div>
                <div class="stat-item"><span class="stat-label">主导 (DOM)</span><div class="stat-bar-container"><div class="stat-bar" id="dom-bar"></div></div><span class="stat-value" id="dom-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">力量 (STR)</span><div class="stat-bar-container"><div class="stat-bar" id="str-bar"></div></div><span class="stat-value" id="str-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">社交 (COM)</span><div class="stat-bar-container"><div class="stat-bar" id="com-bar"></div></div><span class="stat-value" id="com-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">独处 (SOL)</span><div class="stat-bar-container"><div class="stat-bar" id="sol-bar"></div></div><span class="stat-value" id="sol-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">敏捷 (AGI)</span><div class="stat-bar-container"><div class="stat-bar" id="agi-bar"></div></div><span class="stat-value" id="agi-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">安全 (SEC)</span><div class="stat-bar-container"><div class="stat-bar" id="sec-bar"></div></div><span class="stat-value" id="sec-value">0%</span></div>
                <div class="stat-item"><span class="stat-label">魅力 (AES)</span><div class="stat-bar-container"><div class="stat-bar" id="aes-bar"></div></div><span class="stat-value" id="aes-value">0%</span></div>
            </div>

            <!-- === [恢复] CP匹配区UI结构 === -->
            <div id="cp-match-section">
                <div class="cp-title">
                    <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                    你的灵魂伴侣
                </div>
                <p id="cp-reason"></p>
                <p class="cp-footer">那个与你完美共鸣的灵魂是：<strong id="cp-animal"></strong></p>
            </div>

            <div class="button-group">
                <button id="restart-btn" class="restart-button">再测一次</button>
                <button id="browse-btn" class="browse-button">浏览所有动物塑</button>
            </div>
        </div>

        <div id="animal-guide-screen" class="screen hidden">
            <button id="back-to-result-btn" class="back-button">← 返回结果</button>
            <h2>动物塑图鉴</h2>
            <div id="animal-guide"></div>
        </div>

        <div id="loading-screen" class="screen hidden">
            <div class="loader"></div>
            <p style="text-align:center;">正在解析你的动物塑形象...</p>
        </div>
    </div>
    
    <script src="data.js"></script>
    
    <script>
    const dimensionKeys = ["DOM", "STR", "COM", "SOL", "AGI", "SEC", "AES"];
    const screens = { coupon: document.getElementById('coupon-screen'), start: document.getElementById('start-screen'), quiz: document.getElementById('quiz-screen'), result: document.getElementById('result-screen'), guide: document.getElementById('animal-guide-screen'), loading: document.getElementById('loading-screen') };
    
    const couponInput = document.getElementById('coupon-input');
    const couponError = document.getElementById('coupon-error');
    const questionTitle = document.getElementById('question-title');
    const optionList = document.getElementById('option-list');
    const progressBar = document.getElementById('progress-bar');
    const questionCounter = document.getElementById('question-counter');
    const animalGuide = document.getElementById('animal-guide');
    const resultDescription = document.getElementById('result-description');
    const cpReason = document.getElementById('cp-reason');
    const cpAnimal = document.getElementById('cp-animal');

    function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.add('hidden')); screens[screenName].classList.remove('hidden'); }
    function formatDescription(text) { return text.replace(/### (.*?)\n/g, '<h3>\$1</h3>'); }
    
    function initAnimalGuide() {
        animalGuide.innerHTML = '';
        Object.keys(animalArchetypes).forEach(animal => {
            const card = document.createElement('div');
            card.className = 'animal-card';
            card.innerHTML = `<h3>【 ${animal} 】</h3><p>${formatDescription(animalArchetypes[animal].desc)}</p>`;
            animalGuide.appendChild(card);
        });
    }

    function startQuiz() {
        showScreen('quiz');
        renderQuestion();
    }

    function renderQuestion() {
        if (currentQuestionIndex >= quizData.length) { showResult(); return; }
        const q = quizData[currentQuestionIndex];
        questionTitle.textContent = `${currentQuestionIndex + 1}. ${q.question}`;
        questionCounter.textContent = `${currentQuestionIndex + 1}`;
        progressBar.style.width = `${((currentQuestionIndex) / quizData.length) * 100}%`;
        document.getElementById('back-btn').style.visibility = currentQuestionIndex > 0 ? 'visible' : 'hidden';
        optionList.innerHTML = '';
        Object.keys(q.options).forEach(key => {
            const li = document.createElement('li');
            li.className = 'option-item' + (selectedOptions[currentQuestionIndex] === key ? ' selected' : '');
            li.innerHTML = `<span style="margin-right: 15px; font-weight: bold; color: var(--accent-color); font-size: 1.2em;">${key}</span><span>${q.options[key]}</span>`;
            li.onclick = () => selectOption(key);
            optionList.appendChild(li);
        });
    }

    function selectOption(key) {
        if (isProcessing) return;
        isProcessing = true;
        selectedOptions[currentQuestionIndex] = key;
        currentQuestionIndex++;
        // 增加一个短暂的延迟，让用户看到选中效果
        setTimeout(() => {
            renderQuestion();
            isProcessing = false;
        }, 200);
    }

    function goBack() { if (currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(); } }

    function findBestCP(userAnimalName, userVector) {
        let bestCP = null; let maxScore = -Infinity;
        Object.keys(animalArchetypes).forEach(cpAnimalName => {
            if (cpAnimalName === userAnimalName) return;
            const cpVector = animalArchetypes[cpAnimalName].vector;
            let score = (20 - Math.abs(userVector.SOL - (5 - cpVector.SOL))) + (20 - Math.abs(userVector.COM - (5 - cpVector.COM))) + (Math.abs(userVector.SEC - cpVector.DOM) * 3) + (Math.min(userVector.AES, cpVector.AES) * 2) + (Math.min(userVector.STR, cpVector.STR) * 2);
            if (score > maxScore) { maxScore = score; bestCP = cpAnimalName; }
        });
        return bestCP || '水豚';
    }

    // [新增] 数据可视化渲染函数
    function displayResultStats(finalScores) {
        const maxPossibleScore = quizData.length * 2;
        const stats = {};
        dimensionKeys.forEach(key => {
            const value = finalScores[key] || 0;
            const percentage = maxPossibleScore > 0 ? Math.round((value / maxPossibleScore) * 100 * dimensionKeys.length * 0.5) : 0;
            stats[key] = Math.min(100, Math.max(0, percentage));
        });
        
        dimensionKeys.forEach(key => {
            const barId = `${key.toLowerCase()}-bar`;
            const valueId = `${key.toLowerCase()}-value`;
            const barElement = document.getElementById(barId);
            const valueElement = document.getElementById(valueId);
            setTimeout(() => {
                if(barElement) barElement.style.width = `${stats[key]}%`;
                if(valueElement) valueElement.textContent = `${stats[key]}%`;
            }, 300);
        });
        
        const chart = document.querySelector('.stats-chart');
        chart.innerHTML = ''; // 清空旧图表
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute('viewBox', '0 0 200 200');
        chart.appendChild(svg);
        const centerX = 100, centerY = 100, radius = 80, numAxes = dimensionKeys.length;
        
        for(let i = 4; i > 0; i--) { // 绘制背景蛛网
            const points = dimensionKeys.map((_, j) => {
                const angle = (j / numAxes) * 2 * Math.PI - Math.PI / 2;
                return `${centerX + radius * (i/4) * Math.cos(angle)},${centerY + radius * (i/4) * Math.sin(angle)}`;
            }).join(' ');
            const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            polygon.setAttribute('points', points);
            polygon.setAttribute('fill', 'transparent');
            polygon.setAttribute('stroke', 'rgba(226, 232, 240, 0.7)');
            svg.appendChild(polygon);
        }

        const valuePoints = dimensionKeys.map((key, i) => { // 绘制数据多边形
            const angle = (i / numAxes) * 2 * Math.PI - Math.PI / 2;
            const r = radius * (stats[key] / 100);
            return `${centerX + r * Math.cos(angle)},${centerY + r * Math.sin(angle)}`;
        }).join(' ');
        
        const valuePolygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        valuePolygon.setAttribute('points', valuePoints);
        valuePolygon.setAttribute('fill', 'rgba(107, 70, 193, 0.4)');
        valuePolygon.setAttribute('stroke', 'rgba(107, 70, 193, 0.9)');
        valuePolygon.setAttribute('stroke-width', '2');
        svg.appendChild(valuePolygon);
    }

    function showResult() {
        showScreen('loading');
        setTimeout(() => {
            scores = {};
            dimensionKeys.forEach(key => scores[key] = 0);
            selectedOptions.forEach((option, i) => {
                if (option && scoreMap[i] && scoreMap[i][option]) {
                    const questionScores = scoreMap[i][option];
                    for (const dim in questionScores) { scores[dim] = (scores[dim] || 0) + questionScores[dim]; }
                }
            });
            let bestMatchAnimal = '水豚', minDifference = Infinity;
            Object.keys(animalArchetypes).forEach(animalName => {
                const animalVector = animalArchetypes[animalName].vector;
                let diff = 0;
                dimensionKeys.forEach(key => diff += Math.pow((scores[key] || 0) - (animalVector[key] || 0), 2));
                if (diff < minDifference) { minDifference = diff; bestMatchAnimal = animalName; }
            });
            
            const resultData = animalArchetypes[bestMatchAnimal];
            document.getElementById('result-animal').textContent = `【 ${bestMatchAnimal} 】`;
            resultDescription.innerHTML = formatDescription(resultData.desc);
            
            // [调用] 渲染数据可视化和CP匹配
            displayResultStats(scores);
            const bestCPName = findBestCP(bestMatchAnimal, resultData.vector);
            cpReason.textContent = resultData.getCpInterpretation(bestMatchAnimal, bestCPName);
            cpAnimal.textContent = `【 ${bestCPName} 】`;

            showScreen('result');
        }, 1500);
    }
    
    async function verifyCoupon() {
        const inputCode = couponInput.value.trim();
        if (!inputCode) { couponError.textContent = '请输入卡券密码。'; return; }
        const API_TOKEN = 'uskDUbM4CPy64coNePFs9Uk'; 
        const DATASHEET_ID = 'dstXlyh1k5ssc91ha5';
        const CODE_FIELD_NAME = 'code';
        const USED_FIELD_NAME = 'used';
        const verifyBtn = document.getElementById('verify-btn');
        verifyBtn.disabled = true;
        verifyBtn.textContent = '验证中...';
        couponError.textContent = '';
        try {
            const queryUrl = `https://api.vika.cn/fusion/v1/datasheets/${DATASHEET_ID}/records?filterByFormula={${CODE_FIELD_NAME}}="${inputCode}"&fieldKey=name`;
            const queryResponse = await fetch(queryUrl, { headers: { 'Authorization': `Bearer ${API_TOKEN}` } });
            if (!queryResponse.ok) throw new Error(`网络错误: ${queryResponse.statusText}`);
            const queryResult = await queryResponse.json();
            if (!queryResult.success || queryResult.data.records.length === 0) {
                couponError.textContent = '卡券不存在或无效';
            } else {
                const record = queryResult.data.records[0];
                if (record.fields[USED_FIELD_NAME] === true) {
                    couponError.textContent = '此卡券已被使用';
                } else {
                    const updateUrl = `https://api.vika.cn/fusion/v1/datasheets/${DATASHEET_ID}/records`;
                    await fetch(updateUrl, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${API_TOKEN}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ records: [{ recordId: record.recordId, fields: { [USED_FIELD_NAME]: true } }], fieldKey: 'name' })
                    });
                    showScreen('start');
                }
            }
        } catch (error) {
            console.error('验证出错:', error);
            couponError.textContent = '验证服务出现问题，请稍后再试。';
        } finally {
            verifyBtn.disabled = false;
            verifyBtn.textContent = '验证并开始测试';
        }
    }

    document.getElementById('start-btn').addEventListener('click', startQuiz);
    document.getElementById('restart-btn').addEventListener('click', () => {
        currentQuestionIndex = 0; selectedOptions = []; scores = {};
        showScreen('coupon');
    });
    document.getElementById('back-btn').addEventListener('click', goBack);
    document.getElementById('browse-btn').addEventListener('click', () => showScreen('guide'));
    document.getElementById('back-to-result-btn').addEventListener('click', () => showScreen('result'));
    document.getElementById('verify-btn').addEventListener('click', verifyCoupon);
    couponInput.addEventListener('keypress', e => { if (e.key === 'Enter') verifyCoupon(); });

    window.addEventListener('DOMContentLoaded', () => {
        if (typeof quizData === 'undefined') { document.body.innerHTML = '错误：未能加载data.js。'; return; }
        initAnimalGuide();
    });
    </script>
</body>
</html>
